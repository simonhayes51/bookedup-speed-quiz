{% extends "layout.html" %}{% block content %}
<h3>{{ 'Edit Quiz' if quiz.id else 'New Quiz' }}</h3>
<form id='quizForm' method='post' action='/admin/quizzes/save'>
  <input type='hidden' name='qid' value='{{ quiz.id if quiz.id else "" }}'>
  <div class='card'><label>Title</label><input name='title' value='{{ quiz.title }}' required></div>
  <div id='questions'></div>
  <div class='flex'><button class='btn' type='button' onclick='addQ()'>Add Question</button><button class='btn' type='submit'>Save</button><span class='small'>Tip: upload images at bottom</span></div>
  <input type='hidden' name='questions_json' id='questions_json'>
</form>
<div class='card'>
  <h4>Upload Image</h4>
  <input type='file' id='imgfile'><button class='btn' type='button' onclick='uploadImg()'>Upload</button>
  <div class='small' id='imgurl'></div>
</div>
<script>
const start = {{ questions | tojson }};
const container = document.getElementById('questions');
function addQ(q){
  q = q || {id:'', text:'', options:['','','',''], answer:0, timeLimit:20000, imageUrl:''};
  const idx = container.children.length;
  const wrap = document.createElement('div'); wrap.className='card';
  wrap.innerHTML = `
    <div class='grid'>
      <input placeholder='Question text' value="${q.text.replace(/"/g,'&quot;')}" data-k='text'>
      <input placeholder='Image URL (optional)' value="${(q.imageUrl||'').replace(/"/g,'&quot;')}" data-k='imageUrl'>
      <input placeholder='A' value="${q.options[0].replace(/"/g,'&quot;')}" data-k='opt0'>
      <input placeholder='B' value="${q.options[1].replace(/"/g,'&quot;')}" data-k='opt1'>
      <input placeholder='C' value="${q.options[2].replace(/"/g,'&quot;')}" data-k='opt2'>
      <input placeholder='D' value="${q.options[3].replace(/"/g,'&quot;')}" data-k='opt3'>
      <label>Correct (0=A .. 3=D)</label><input type='number' min='0' max='3' value="${q.answer}" data-k='answer'>
      <label>Time (ms)</label><input type='number' min='5000' step='1000' value="${q.timeLimit}" data-k='timeLimit'>
      <button class='btn secondary' type='button' onclick='this.closest(".card").remove()'>Remove</button>
    </div>`;
  container.appendChild(wrap);
}
start.forEach(addQ);
document.getElementById('quizForm').addEventListener('submit', (e)=>{
  const blocks = container.querySelectorAll('.card');
  const list = [];
  blocks.forEach((b,i)=>{
    const get = k => b.querySelector(`[data-k="${k}"]`).value.trim();
    list.push({
      id: 'q'+(i+1),
      text: get('text'),
      options: [get('opt0'),get('opt1'),get('opt2'),get('opt3')],
      answer: parseInt(get('answer')||'0',10),
      timeLimit: parseInt(get('timeLimit')||'20000',10),
      imageUrl: get('imageUrl') || null
    });
  });
  document.getElementById('questions_json').value = JSON.stringify(list);
});
async function uploadImg(){
  const f = document.getElementById('imgfile').files[0];
  if(!f){ alert('Pick a file first'); return; }
  const fd = new FormData(); fd.append('file', f);
  const res = await fetch('/admin/upload_image', { method:'POST', body: fd });
  if(!res.ok){ alert('Upload failed'); return; }
  const data = await res.json();
  document.getElementById('imgurl').innerText = data.url;
  navigator.clipboard && navigator.clipboard.writeText(data.url);
  alert('Uploaded. URL copied to clipboard: ' + data.url);
}
</script>
{% endblock %}