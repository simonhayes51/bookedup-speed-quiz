{% extends "layout.html" %}
{% block content %}
<section class="card">
  <h2>Team</h2>

  <div class="row">
    <input id="roomInput" placeholder="Room code"/>
    <input id="nameInput" placeholder="Team name" value="Team"/>
    <button id="joinBtn" class="primary">Join</button>
  </div>

  <div id="prompt" class="qtext"></div>

  <div class="grid4">
    <button id="btn0" class="opt">A</button>
    <button id="btn1" class="opt">B</button>
    <button id="btn2" class="opt">C</button>
    <button id="btn3" class="opt">D</button>
  </div>

  <div id="status"></div>
</section>

<script>
let ws, queue = [], joined = false;

function wsUrl(){ const p = location.protocol==='https:'?'wss':'ws'; return `${p}://${location.host}/ws`; }
function sendJSON(o){ if(ws && ws.readyState===WebSocket.OPEN){ ws.send(JSON.stringify(o)); } else { queue.push(o); } }
function flush(){ while(queue.length && ws.readyState===WebSocket.OPEN){ ws.send(JSON.stringify(queue.shift())); } }

function connectTeam(roomId, name){
  if(ws && (ws.readyState===WebSocket.OPEN || ws.readyState===WebSocket.CONNECTING)) return;
  ws = new WebSocket(wsUrl());
  ws.onopen = () => { ws.send(JSON.stringify({ role:'team', roomId, teamName:name })); flush(); };
  ws.onmessage = (ev) => {
    const m = JSON.parse(ev.data||'{}');
    if(m.type==='team:joined'){ joined = true; document.getElementById('status').textContent = 'Joined'; }
    if(m.type==='question:prompt'){
      document.getElementById('prompt').textContent = m.text || '';
      document.querySelectorAll('.opt').forEach(b=>b.disabled=false);
    }
    if(m.type==='question:locked'){
      document.querySelectorAll('.opt').forEach(b=>b.disabled=true);
    }
    if(m.type==='answer:accepted'){
      document.getElementById('status').textContent = `Answer submitted (${Math.round((m.remainingMs||0)/1000)}s left)`;
      document.querySelectorAll('.opt').forEach(b=>b.disabled=true);
    }
  };
  ws.onclose = () => setTimeout(()=>connectTeam(roomId, name), 1000);
  ws.onerror = () => { try{ ws.close(); }catch(e){} };
}

document.getElementById('joinBtn').addEventListener('click', ()=>{
  const roomId = document.getElementById('roomInput').value.trim();
  const name = document.getElementById('nameInput').value.trim() || 'Team';
  if(roomId) connectTeam(roomId, name);
});

[0,1,2,3].forEach(i=>{
  document.getElementById(`btn${i}`).addEventListener('click', ()=>{
    if(!joined) return;
    sendJSON({ type:'team:answer', option:i });
  });
});
</script>
{% endblock %}
